name: Build and Deploy Debian Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      # 1. ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: source
        
      # 2. ÌïÑÏöîÌïú ÎèÑÍµ¨ ÏÑ§Ïπò
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev reprepro
          
      # 3. GPG ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          
      # 4. ÎπåÎìú Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
      - name: Build Debian package
        working-directory: source
        run: |
          #!/bin/bash
          set -e
          
          echo "=== Starting Debian package build ==="
          
          # DEBIAN/controlÏóêÏÑú Ìå®ÌÇ§ÏßÄ Ï†ïÎ≥¥ Ï∂îÏ∂ú
          PACKAGE_NAME=$(grep '^Package:' DEBIAN/control | awk '{print $2}')
          PACKAGE_VERSION=$(grep '^Version:' DEBIAN/control | awk '{print $2}')
          PACKAGE_ARCH=$(grep '^Architecture:' DEBIAN/control | awk '{print $2}')
          
          echo "Building: ${PACKAGE_NAME}_${PACKAGE_VERSION}_${PACKAGE_ARCH}"
          
          # Ìå®ÌÇ§ÏßÄ Íµ¨Ï°∞ ÏÉùÏÑ±
          BUILD_DIR="build_${PACKAGE_NAME}"
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          
          # DEBIAN ÎîîÎ†âÌÜ†Î¶¨ Î≥µÏÇ¨
          cp -r DEBIAN "${BUILD_DIR}/"
          
          # ÌååÏùº Î≥µÏÇ¨
          if [ -d "usr" ]; then
            cp -r usr "${BUILD_DIR}/"
          fi
          
          if [ -d "etc" ]; then
            cp -r etc "${BUILD_DIR}/"
          fi
          
          if [ -d "bin" ]; then
            mkdir -p "${BUILD_DIR}/usr/bin"
            cp -r bin/* "${BUILD_DIR}/usr/bin/"
            chmod +x "${BUILD_DIR}/usr/bin/"*
          fi
          
          # .deb ÌååÏùº ÎπåÎìú
          DEB_FILENAME="${PACKAGE_NAME}_${PACKAGE_VERSION}_${PACKAGE_ARCH}.deb"
          dpkg-deb --build "${BUILD_DIR}" "${DEB_FILENAME}"
          
          echo "Package built: ${DEB_FILENAME}"
          
          # ÎπåÎìúÎêú ÌååÏùºÏùÑ ÏÉÅÏúÑ ÎîîÎ†âÌÜ†Î¶¨Î°ú Î≥µÏÇ¨
          cp "${DEB_FILENAME}" ../
          
          # ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï
          echo "DEB_FILENAME=${DEB_FILENAME}" >> $GITHUB_ENV
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "PACKAGE_VERSION=${PACKAGE_VERSION}" >> $GITHUB_ENV
          
      # 5. gh-pages Î∏åÎûúÏπò Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true
        
      # 6. gh-pages ÎîîÎ†âÌÜ†Î¶¨ Ï¥àÍ∏∞Ìôî (ÌïÑÏöîÏãú)
      - name: Initialize gh-pages directory
        run: |
          if [ ! -d "gh-pages" ]; then
            echo "Creating gh-pages directory..."
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            cd ..
          fi
          
      # 7. APT Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (Ïù¥Ï†Ñ Î≤ÑÏ†Ñ Ïú†ÏßÄ)
      - name: Update APT repository (keeping old versions)
        working-directory: gh-pages
        run: |
          #!/bin/bash
          set -e
          
          echo "=== Updating APT repository ==="
          
          # .deb ÌååÏùº Î≥µÏÇ¨
          cp ../${DEB_FILENAME} .
          
          # reprepro ÏÑ§Ï†ï ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p conf
          
          # distributions ÌååÏùº ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏
          cat > conf/distributions <<EOF
          Origin: ${GITHUB_REPOSITORY_OWNER}
          Label: ${GITHUB_REPOSITORY##*/}
          Codename: stable
          Architectures: amd64 arm64 armhf i386
          Components: main
          Description: APT repository for ${GITHUB_REPOSITORY##*/}
          SignWith: ${{ steps.import_gpg.outputs.keyid }}
          EOF
          
          # options ÌååÏùº ÏÉùÏÑ± (verbose Ï∂úÎ†•)
          cat > conf/options <<EOF
          verbose
          basedir .
          EOF
          
          # Ï†ÄÏû•ÏÜåÍ∞Ä Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
          if [ -d "pool" ] && [ -d "dists" ]; then
            echo "Repository exists, updating..."
            
            # ÎèôÏùºÌïú Î≤ÑÏ†ÑÏù¥ Ïù¥ÎØ∏ ÏûàÎäîÏßÄ ÌôïÏù∏
            if reprepro list stable | grep -q "${PACKAGE_NAME}_${PACKAGE_VERSION}"; then
              echo "Version ${PACKAGE_VERSION} already exists. Removing old version first..."
              # Í∏∞Ï°¥ Î≤ÑÏ†Ñ Ï†úÍ±∞
              reprepro -V remove stable ${PACKAGE_NAME} ${PACKAGE_VERSION}
            fi
            
            # ÏÉà Ìå®ÌÇ§ÏßÄ Ï∂îÍ∞Ä
            reprepro -V includedeb stable "${DEB_FILENAME}"
          else
            echo "Creating new repository..."
            # ÏÉà Ï†ÄÏû•ÏÜå ÏÉùÏÑ±
            reprepro -V includedeb stable "${DEB_FILENAME}"
          fi
          
          # Ï†ÄÏû•ÏÜå ÏÉÅÌÉú ÌôïÏù∏
          echo ""
          echo "=== Repository Status ==="
          reprepro list stable
          echo ""
          
          # Ïò§ÎûòÎêú Î≤ÑÏ†Ñ Ï†úÍ±∞ ÏòµÏÖò (ÏÑ†ÌÉùÏ†Å)
          # ÏµúÎåÄ 3Í∞ú Î≤ÑÏ†ÑÎßå Ïú†ÏßÄÌïòÎ†§Î©¥ ÏïÑÎûò Ï£ºÏÑù Ìï¥Ï†ú
          # echo "Removing old versions (keeping last 3)..."
          # reprepro --delete clearvanished
          # reprepro deleteunreferenced
          
      # 8. Public GPG ÌÇ§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
      - name: Export public GPG key
        working-directory: gh-pages
        run: |
          echo "Exporting GPG public key..."
          gpg --armor --export ${{ steps.import_gpg.outputs.keyid }} > public.key
          
          if [ ! -s public.key ]; then
            echo "ERROR: public.key is empty!"
            gpg --armor --export > public.key
          fi
          
          echo "Public key file size: $(wc -c < public.key) bytes"
          
      # 9. Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏
      - name: Update documentation
        working-directory: gh-pages
        run: |
          # ÌòÑÏû¨ Ï†ÄÏû•ÏÜåÏùò Î™®Îì† Ìå®ÌÇ§ÏßÄ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
          PACKAGE_LIST=$(reprepro list stable | awk '{print $2}' | sort -u)
          
          # README.md ÏóÖÎç∞Ïù¥Ìä∏
          cat > README.md <<EOF
          # APT Repository for ${GITHUB_REPOSITORY##*/}
          
          ## Installation
          
          ### Add GPG key and repository
          \`\`\`bash
          # Modern way (Ubuntu 22.04+, Debian 11+)
          curl -fsSL https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/public.key | sudo gpg --dearmor -o /etc/apt/keyrings/${GITHUB_REPOSITORY##*/}.gpg
          echo "deb [signed-by=/etc/apt/keyrings/${GITHUB_REPOSITORY##*/}.gpg] https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/ stable main" | sudo tee /etc/apt/sources.list.d/${GITHUB_REPOSITORY##*/}.list
          
          # Legacy way (older systems)
          curl -fsSL https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/public.key | sudo apt-key add -
          echo "deb https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/ stable main" | sudo tee /etc/apt/sources.list.d/${GITHUB_REPOSITORY##*/}.list
          \`\`\`
          
          ### Install package
          \`\`\`bash
          sudo apt update
          sudo apt install ${PACKAGE_NAME}
          \`\`\`
          
          ### Install specific version
          \`\`\`bash
          # List available versions
          apt-cache madison ${PACKAGE_NAME}
          
          # Install specific version
          sudo apt install ${PACKAGE_NAME}=VERSION
          \`\`\`
          
          ## Available Packages
          
          \`\`\`
          $(reprepro list stable)
          \`\`\`
          
          Last updated: $(date)
          EOF
          
          # index.html ÏóÖÎç∞Ïù¥Ìä∏
          cat > index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>APT Repository - ${GITHUB_REPOSITORY##*/}</title>
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
                      max-width: 900px; 
                      margin: 0 auto; 
                      padding: 40px 20px; 
                      background: #f5f5f5;
                  }
                  .container {
                      background: white;
                      border-radius: 8px;
                      padding: 30px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  pre { 
                      background: #f6f8fa; 
                      padding: 16px; 
                      border-radius: 6px; 
                      overflow-x: auto;
                      border: 1px solid #e1e4e8;
                  }
                  code { 
                      background: #f6f8fa; 
                      padding: 2px 6px; 
                      border-radius: 3px;
                      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
                  }
                  h1 { 
                      border-bottom: 2px solid #e1e4e8; 
                      padding-bottom: 10px;
                      color: #24292e;
                  }
                  h2 {
                      color: #24292e;
                      margin-top: 30px;
                  }
                  .package-info {
                      background: #f0f9ff;
                      border: 1px solid #0969da;
                      border-radius: 6px;
                      padding: 15px;
                      margin: 20px 0;
                  }
                  .version-list {
                      background: #f6f8fa;
                      border-radius: 6px;
                      padding: 15px;
                      margin: 15px 0;
                  }
                  a {
                      color: #0969da;
                      text-decoration: none;
                  }
                  a:hover {
                      text-decoration: underline;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üì¶ APT Repository</h1>
                  <p>Debian package repository for <strong>${GITHUB_REPOSITORY##*/}</strong></p>
                  
                  <div class="package-info">
                      <strong>üìã Latest Version:</strong> ${PACKAGE_VERSION}<br>
                      <strong>üì¶ Package Name:</strong> ${PACKAGE_NAME}<br>
                      <strong>üîÑ Total Versions:</strong> $(reprepro list stable | wc -l)
                  </div>
                  
                  <h2>üöÄ Quick Setup</h2>
                  <pre><code># For Ubuntu 22.04+ / Debian 11+
          curl -fsSL https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/public.key | \\
            sudo gpg --dearmor -o /etc/apt/keyrings/${GITHUB_REPOSITORY##*/}.gpg
          
          echo "deb [signed-by=/etc/apt/keyrings/${GITHUB_REPOSITORY##*/}.gpg] \\
            https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/ stable main" | \\
            sudo tee /etc/apt/sources.list.d/${GITHUB_REPOSITORY##*/}.list
          
          sudo apt update
          sudo apt install ${PACKAGE_NAME}</code></pre>
                  
                  <h2>üì¶ Available Versions</h2>
                  <div class="version-list">
                      <pre>$(reprepro list stable)</pre>
                  </div>
                  
                  <h2>üîß Version Management</h2>
                  <pre><code># List available versions
          apt-cache madison ${PACKAGE_NAME}
          
          # Install specific version
          sudo apt install ${PACKAGE_NAME}=1.0-1
          
          # Downgrade to older version
          sudo apt install ${PACKAGE_NAME}=0.9-1 --allow-downgrades</code></pre>
                  
                  <h2>üìÅ Browse Repository</h2>
                  <ul>
                      <li><a href="pool/">üì¶ Package Pool</a> - All .deb files</li>
                      <li><a href="dists/">üìã Distributions</a> - Repository metadata</li>
                      <li><a href="public.key">üîë GPG Public Key</a> - Repository signing key</li>
                  </ul>
                  
                  <hr>
                  <p><small>Last updated: $(date)</small></p>
              </div>
          </body>
          </html>
          EOF
          
      # 10. Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïª§Î∞ã Î∞è Ìë∏Ïãú
      - name: Commit and push to gh-pages
        working-directory: gh-pages
        run: |
          echo "=== Files to be committed ==="
          ls -la
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          git status
          
          # Ïª§Î∞ã Î©îÏãúÏßÄÏóê Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Ìè¨Ìï®
          git commit -m "Add ${PACKAGE_NAME} version ${PACKAGE_VERSION}" || echo "No changes to commit"
          
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git 2>/dev/null || true
          git push -f origin gh-pages
          
      # 11. GitHub Pages ÌôúÏÑ±Ìôî
      - name: Enable GitHub Pages
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            2>/dev/null || echo "GitHub Pages already enabled"
            
      # 12. ÏôÑÎ£å Î©îÏãúÏßÄ
      - name: Display completion message
        run: |
          echo "=========================================="
          echo "‚úÖ Deployment Complete!"
          echo "=========================================="
          echo "üì¶ Package: ${DEB_FILENAME}"
          echo "üìã Version: ${PACKAGE_VERSION}"
          echo "üåê Repository: https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/"
          echo ""
          echo "üìù Install commands:"
          echo "  sudo apt update"
          echo "  sudo apt install ${PACKAGE_NAME}"
          echo "=========================================="
