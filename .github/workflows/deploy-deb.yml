name: Build and Deploy Debian Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 2. 필요한 도구 설치
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev reprepro
          
      # 3. GPG 키 가져오기 (비밀번호 없는 키)
      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          
      # 4. 빌드 스크립트 생성 및 실행
      - name: Build Debian package
        run: |
          #!/bin/bash
          set -e
          
          echo "=== Starting Debian package build ==="
          
          # DEBIAN/control에서 패키지 정보 추출
          PACKAGE_NAME=$(grep '^Package:' DEBIAN/control | awk '{print $2}')
          PACKAGE_VERSION=$(grep '^Version:' DEBIAN/control | awk '{print $2}')
          PACKAGE_ARCH=$(grep '^Architecture:' DEBIAN/control | awk '{print $2}')
          
          echo "Building: ${PACKAGE_NAME}_${PACKAGE_VERSION}_${PACKAGE_ARCH}"
          
          # 패키지 구조 생성
          BUILD_DIR="build_${PACKAGE_NAME}"
          rm -rf "${BUILD_DIR}"
          mkdir -p "${BUILD_DIR}"
          
          # DEBIAN 디렉토리 복사
          cp -r DEBIAN "${BUILD_DIR}/"
          
          # 파일 복사 (디렉토리 구조 유지)
          if [ -d "usr" ]; then
            cp -r usr "${BUILD_DIR}/"
          fi
          
          if [ -d "etc" ]; then
            cp -r etc "${BUILD_DIR}/"
          fi
          
          if [ -d "bin" ]; then
            mkdir -p "${BUILD_DIR}/usr/bin"
            cp -r bin/* "${BUILD_DIR}/usr/bin/"
            chmod +x "${BUILD_DIR}/usr/bin/"*
          fi
          
          # .deb 파일 빌드
          DEB_FILENAME="${PACKAGE_NAME}_${PACKAGE_VERSION}_${PACKAGE_ARCH}.deb"
          dpkg-deb --build "${BUILD_DIR}" "${DEB_FILENAME}"
          
          echo "Package built: ${DEB_FILENAME}"
          echo "DEB_FILENAME=${DEB_FILENAME}" >> $GITHUB_ENV
          
      # 5. gh-pages 브랜치 체크아웃 또는 생성
      - name: Prepare gh-pages branch
        run: |
          #!/bin/bash
          set -e
          
          # gh-pages 브랜치 체크아웃 시도
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          
          if git show-ref --verify --quiet refs/heads/gh-pages; then
            echo "gh-pages branch exists, checking out..."
            git checkout gh-pages
            # main 브랜치의 최신 .deb 파일 가져오기
            git checkout main -- *.deb 2>/dev/null || true
          else
            echo "Creating new gh-pages branch..."
            git checkout --orphan gh-pages
            # 모든 파일 제거 (새 브랜치이므로)
            git rm -rf . 2>/dev/null || true
          fi
          
      # 6. APT 저장소 생성/업데이트
      - name: Create/Update APT repository
        run: |
          #!/bin/bash
          set -e
          
          echo "=== Setting up APT repository ==="
          
          # reprepro 설정 디렉토리 생성
          mkdir -p conf
          
          # distributions 파일 생성
          cat > conf/distributions <<EOF
          Origin: ${GITHUB_REPOSITORY_OWNER}
          Label: ${GITHUB_REPOSITORY##*/}
          Codename: stable
          Architectures: amd64 arm64 armhf i386
          Components: main
          Description: APT repository for ${GITHUB_REPOSITORY##*/}
          SignWith: ${{ steps.import_gpg.outputs.keyid }}
          EOF
          
          # 이전 저장소 상태 정리 (있는 경우)
          if [ -d "db" ] || [ -d "dists" ] || [ -d "pool" ]; then
            echo "Cleaning previous repository state..."
            rm -rf db dists pool
          fi
          
          # 패키지 추가
          echo "Adding package to repository..."
          reprepro -V includedeb stable "${DEB_FILENAME}"
          
          # 저장소 export (메타데이터 생성)
          reprepro -V export
          
          echo "Repository created/updated successfully"
          
      # 7. Public GPG 키 추가 (사용자가 저장소를 신뢰할 수 있도록)
      - name: Export public GPG key
        run: |
          gpg --armor --export ${{ steps.import_gpg.outputs.keyid }} > public.key
          echo "Public GPG key exported to public.key"
          
      # 8. README 생성 (저장소 사용 방법)
      - name: Create README
        run: |
          cat > README.md <<EOF
          # APT Repository for ${GITHUB_REPOSITORY##*/}
          
          ## Usage
          
          1. Add the GPG key:
          \`\`\`bash
          curl -fsSL https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/public.key | sudo apt-key add -
          \`\`\`
          
          2. Add the repository:
          \`\`\`bash
          echo "deb https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/ stable main" | sudo tee /etc/apt/sources.list.d/${GITHUB_REPOSITORY##*/}.list
          \`\`\`
          
          3. Update and install:
          \`\`\`bash
          sudo apt update
          sudo apt install ${PACKAGE_NAME}
          \`\`\`
          
          ## Available Packages
          
          - ${DEB_FILENAME}
          
          Last updated: $(date)
          EOF
          
      # 9. GitHub Pages 설정을 위한 index.html 생성
      - name: Create index.html
        run: |
          cat > index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>APT Repository - ${GITHUB_REPOSITORY##*/}</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                  code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
              </style>
          </head>
          <body>
              <h1>APT Repository for ${GITHUB_REPOSITORY##*/}</h1>
              
              <h2>Quick Setup</h2>
              <pre>
          # Add GPG key
          curl -fsSL https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/public.key | sudo apt-key add -
          
          # Add repository
          echo "deb https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/ stable main" | sudo tee /etc/apt/sources.list.d/${GITHUB_REPOSITORY##*/}.list
          
          # Install package
          sudo apt update
          sudo apt install ${PACKAGE_NAME}
              </pre>
              
              <h2>Browse</h2>
              <ul>
                  <li><a href="pool/">Package Pool</a></li>
                  <li><a href="dists/">Distributions</a></li>
                  <li><a href="public.key">GPG Public Key</a></li>
              </ul>
              
              <p><small>Last updated: $(date)</small></p>
          </body>
          </html>
          EOF
          
      # 10. 변경사항 커밋 및 푸시
      - name: Commit and push to gh-pages
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          git commit -m "Update APT repository: ${DEB_FILENAME}" || echo "No changes to commit"
          git push origin gh-pages
          
      # 11. GitHub Pages 활성화
      - name: Enable GitHub Pages
        run: |
          # GitHub Pages 설정 (API 사용)
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/pages" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            2>/dev/null || echo "GitHub Pages might already be enabled"
            
      # 12. 완료 메시지
      - name: Display completion message
        run: |
          echo "=========================================="
          echo "✅ Deployment Complete!"
          echo "=========================================="
          echo "Repository URL: https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY##*/}/"
          echo "Package: ${DEB_FILENAME}"
          echo "=========================================="
